<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.43/Tone.js"></script>
        <title>MIDI SESSION</title>
    </head>
    <body>
        <p id="my_id"></p>
        <input type="button" id="button_create" value="Create Room"><br>
        <input type="text" id="input_id" placeholder="RoomID">
        <input type="button" id="button_join" value="Join">
        <pre id="log"></pre>
    </body>

    <script>
        let button_create = document.getElementById('button_create');
        let input_id = document.getElementById('input_id');
        let button_join = document.getElementById('button_join');
        let connection;

        navigator.requestMIDIAccess({sysex: true}).then(success, failure);

        function success(midiAccess){
            itr = midiAccess.inputs.values();
            inputs = [];
            for(e = itr.next(); !e.done; e = itr.next()) inputs.push(e.value);
            setInterval(function(){
                input = inputs[0];
                input.onmidimessage = handleMIDIMessage;
            }, 200);
        }

        function failure(error){
            alert("Couldn't detect MIDI input devices. / " + error);
        }

        function handleMIDIMessage(event){
            str = null;
            if(event.data.length > 1){
                str = event.data[0].toString(16) + " ";
                for(i = 1; i < event.data.length; i++){
                    if(event.data[i] < 0x10) str += "0";
                    str += event.data[i].toString(16) + " ";
                }
            }

            if(str != null){
                send(str);
                hex = str[3] + str[4];
                vel = parseInt(str[6] + str[7], 16);
                play(hex, vel);
            }
        }

        function hex_to_note(hex){
            t = parseInt(hex, 16)-21;
            res = "ABBCDDEEFGGA"[t%12];
            if([1, 4, 6, 9, 11].includes(t%12)) res += "b";
            if(t < 3) res += "0";
            else if(t > 86) res += "8";
            else if(res[0] != 'B') res += String(Math.ceil(t/12));
            else res += String(Math.ceil(t/12)-1);
            return res
        }

        // 最初にサンプラー音源を取得
        const sampler = new Tone.Sampler({
            urls: {
                C4: "20200822172728_625a42455a466b4b5a46.mp3",
            },
            baseUrl: "https://f.easyuploader.app/eu-prd/upload/",
        }).toDestination();

        function play(hex, vel){
            velocity = parseInt(vel, 16);
            if(velocity > 0){
                sampler.triggerAttackRelease(hex_to_note(hex), 6, Tone.context.currentTime, Math.min(velocity*velocity/2000, 4));
            }
        }

        // 部屋作成ボタン押下時
        document.getElementById('button_create').onclick = () => {
            // 部屋(Peer)作成
            const peer = new Peer(String(Math.floor(Math.random()*900000+100000)), {
                key: '59214ca8-9cee-4bde-b61d-3d7343c52205',
                debug: 3
            });

            // 作成成功時
            peer.on('open', () => {
                document.getElementById('my_id').textContent = "RoomID: " + peer.id;
                button_create.remove();
                input_id.remove();
                button_join.remove();
            });

            // 誰かが入室してきたとき
            peer.on('connection', conn => {
                conn.on('open', () => {
                    connection.send("Hello World");
                });

                // データ受信時
                conn.on('data', data => {
                    console.log(data);
                });

                connection = conn;
            });
        };

        // 入室ボタン押下時
        document.getElementById('button_join').onclick = () => {
            let room_id = document.getElementById('input_id').value;

            // Peer作成
            const peer = new Peer({
                key: '59214ca8-9cee-4bde-b61d-3d7343c52205',
                debug: 3
            });

            // Peer作成成功時
            peer.on('open', () => {
                // 該当する部屋(Peer)へ入室
                connection = peer.connect(room_id);

                connection.on('open', () => {
                    document.getElementById('my_id').textContent = "RoomID: " + room_id;
                    button_create.remove();
                    input_id.remove();
                    button_join.remove();
                });

                // 接続失敗時
                peer.on('error', error => {
                    alert("RoomID: " + room_id + " doesn't exsist.");
                    document.location.reload();
                });

                // データ受信時
                connection.on('data', data => {
                    console.log(data);
                    hex = data[3] + data[4];
                    vel = parseInt(data[6] + data[7], 16);
                    play(hex, vel);
                });
            })
        };

        function send(data){
            connection.send(data);
        }
    </script>
</html>